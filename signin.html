<!DOCTYPE html>

<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<meta name="misapplication-tap-highlight" content="no"/>
		<meta name="HandheldFriendly" content="true"/>
		<meta name="MobileOptimized" content="320"/>
		<title>登陆</title>
		<link rel="stylesheet" href="css/common.css" />
		<script type="text/javascript">
			// 禁止选择
			document.oncontextmenu = function() {
				return false;
			};
			// 检测是否存在用户登录缓存
			if (localStorage.getItem("user")) {
				location.assign("plus/index.html");
			}
			var ws=null,domready=false;
			// plusready 比 domcontentready 晚
			function plusReady() {
			if (ws||!window.plus||!domready) {
				return;
			}
				plus.navigator.setStatusBarBackground('#444');
			};
			if(window.plus){
				plusReady();
			}else{
				document.addEventListener('plusready', plusReady, false);
			}
			// 监听DOMContentLoaded事件
			document.addEventListener('DOMContentLoaded', function(){
				domready=true;
				plusReady();
			}, false);
			
			// 登录事件
			function signin() {
				var 
					userName = document.getElementById("username").value.replace(/\s*/g, ''),
					userpw = document.getElementById("userpw").value.replace(/\s*/g, ''),
					geturl = "http://192.168.1.213:38080/estapi/api/User/GetLogin?username=" + userName + "&password=" + userpw;
					// geturl = "http://192.168.1.213:38080/estapi/api/User/GetLogin?username=ZC-DN-LZC&password=123456";
				if ((!userName) || (!userpw)) {
					plus.nativeUI.alert("请输入账号及密码", function(){}, "信息框", "确定");
					return;
				}
				var xhr = new plus.net.XMLHttpRequest();
				xhr.onreadystatechange = function() {
					if (xhr.readyState == 4) {
						if (xhr.status == 200) {
							var response = JSON.parse(xhr.responseText);
							if (response.length > 0) {
								console.log(response);
								console.log("responseText: " + xhr.responseText);
								localStorage.setItem("user", xhr.responseText);
								location.assign("plus/index.html");
							}
						} else {
							console.log("responseText: " + xhr.responseText);
							plus.nativeUI.alert("请检查密码及用户名是否正确", function(){}, "登陆失败", "确定");
						}
					}
					
				} 
				// username: this.userName,password: this.userPW
				xhr.open("GET", geturl);
				xhr.send();
			}
			
		</script>
	</head>

	<body>
		<header>
			<div class="title">扫码APP</div>
		</header>
		<div class="contain-wrapper signin">
			<div class="input-item">
				<div class="txt">
					账号：
				</div>
				<div class="item-input">
					<input type="text" name="username" id="username"/>
				</div>
			</div>
			<div class="input-item">
				<div class="txt">
					密码：
				</div>
				<div class="item-input">
					<input type="password" name="userpw" id="userpw"/>
				</div>
			</div>
			<div class="signin-submit">
				<button onclick="signin()">登 陆</button>
			</div>
		</div>
	</body>

</html>